<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <title>OPTIMUS Results Site</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script>
/*here helpful func to work with cookie*/
function getCookie(name, json=false) {
  if (!name) {
    return undefined;
  }
  /*
  Returns cookie with specified name (str) if exists, else - undefined
  if returning value is JSON and json parameter is true, returns json, otherwise str
  */
  let matches = document.cookie.match(new RegExp(
    "(?:^|; )" + name.replace(/([.$?*|{}()\[\]\\\/+^])/g, '\\$1') + "=([^;]*)"
  ));
  if (matches) {
    let res = decodeURIComponent(matches[1]);
    if (json) {
      try {
        return JSON.parse(res);
      }
      catch(e) {}
    }
    return res;
  }
  return undefined;
}
function setCookie(name, value, options = {path: '/', SameSite: 'strict'}) {
  /*
  Sets a cookie with specified name (str), value (str) & options (dict)

  options keys:
    - path (str) - URL, for which this cookie is available (must be absolute!)
    - domain (str) - domain, for which this cookie is available
    - expires (Date object) - expiration date&time of cookie
    - max-age (int) - cookie lifetime in seconds (alternative for expires option)
    - secure (bool) - if true, cookie will be available only for HTTPS.
                      IT CAN'T BE FALSE
    - samesite (str) - XSRF protection setting.
                       Can be strict or lax
                       Read https://web.dev/samesite-cookies-explained/ for details
    - httpOnly (bool) - if true, cookie won't be available for using in JavaScript
                        IT CAN'T BE FALSE
  */
  if (!name) {
    return;
  }

  options = options || {};

  if (options.expires instanceof Date) {
    options.expires = options.expires.toUTCString();
  }

  if (value instanceof Object) {
    value = JSON.stringify(value);
  }
  let updatedCookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);
  for (let optionKey in options) {
    updatedCookie += "; " + optionKey;
    let optionValue = options[optionKey];
    if (optionValue !== true) {
      updatedCookie += "=" + optionValue;
    }
  }
  document.cookie = updatedCookie;
}
function deleteCookie(name) {
  /*
  Deletes a cookie with specified name.
  Returns true when cookie was successfully deleted, otherwise false
  */
  setCookie(name, null, {
    expires: new Date(),
    path: '/',
    samesite: 'strict'
  })
}
</script>

<script>
  var page = 0  //pagination endless/infinity list
  var isLoading = false

  var eventsDir = './events/'
  function getComboA(selectObject) {
    var value = selectObject.value;
    if (value==0) deleteCookie(selectObject.id)
    else setCookie(selectObject.id, value)
    window.location.reload();
  }
  function clearCookie() {
    deleteCookie('Year');
    deleteCookie('Type');
    deleteCookie('Name');
    window.location.reload();
  }
  /* thanks to 
	https://www.toolify.ai/gpts/how-to-implement-infinite-scroll-pagination-with-php-mysql-jquery-366007
	https://sky.pro/media/kak-sozdat-sajt-s-dinamicheskoj-zagruzkoj-kontenta-pri-prokrutke/#title2
*/	

  function loadDataContent() {
    if (isLoading) { return; }
    isLoading = true;
    // получаем из сервера json со списком event
//    fetch('http://127.0.0.1/index.php?page='+page) //здесь вызвать index.php, возвращает json массив event.
    fetch('https://zeroturtle.github.io/events.json') // получаем массив event из json-файла.
      .then(response => response.json())
      .then(json => {

         const template = document.getElementById('event_template');
         const rank_tmpl = document.getElementById("rank_template")
         for (item in json) {
           var event = json[item]
           event.id = item.slice(1)
           event.datefrom = new Date(event.date_start).toDateString()    // преобразуем поле даты в строку
           event.dateto = new Date(event.date_end).toDateString()
           const clone = template.content.cloneNode(true);
           clone.getElementById('event_location').textContent = event.location
           clone.getElementById('event_date').textContent = `${event.datefrom} - ${event.dateto}`
           clone.getElementById('event_name').textContent = event.name
           clone.getElementById('event_link').href = `${eventsDir}${event.id}/`
           clone.getElementById('event_logo1').src = `${eventsDir}${event.id}/Logo1.jpg`
           clone.getElementById('event_logo2').src = `${eventsDir}${event.id}/Logo2.jpg`
           event.events.forEach( (rank, index) => {
             const rank_clone = rank_tmpl.content.cloneNode(true);
             rank_clone.getElementById('rank_link').href = `${eventsDir}${event.id}/?r=${rank.event_id}`
             rank_clone.getElementById('rank_link').textContent = rank.name
             clone.getElementById('event_ranks').appendChild(rank_clone);
           })
           EventsList.appendChild(clone);
         }

        isLoading = false; //для постраничного вывода
        page++
      })
      .catch(error => console.log('Ошибка чтения json:', error)); 
  }

  function isset(variable) {
    return typeof variable !== typeof undefined ? true : false;
  }
  window.addEventListener('load', ()=>{
    ["Year","Type","Name"].forEach((elem)=>{
      document.getElementById(elem).value = (isset(getCookie(elem))) ? getCookie(elem) : ''
    })
    // загружаем первую страницу
    loadDataContent()
    // фильтр по нажатию Enter
    document.getElementById('Name').addEventListener('keypress', function (e) {
      if (event.keyCode === 13 || event.code === "Enter") {
        searchButton.click()
      }
    })
  })
  //подгружаем следующую часть списка в конце страницы
  window.addEventListener('scroll', () => { 
    var scrollPosition = window.innerHeight + window.pageYOffset;
    var pageHeight = document.documentElement.scrollHeight;
    if ((scrollPosition >= pageHeight - 100) && !isLoading) {
      loadDataContent() 
    }
  }); 
      //обработчик ошибок для всех изображений
  function imageError(image) {
    image.onerror = null;
    image.src = "../../images/OPTIMUS3.svg";
  }
</script>
  </head>
  <body lang="en">

<div class="container">

     <!-- page header -->
    <header style="background-image: url(images/Title.jpg); background-size: 100% auto;">
    <!--div style="background: linear-gradient(#b35900 55%, white);"-->
        <div class="row align-items-center">
           <div class="col">
              <a href="#"><img src="images/turtle_logo.png" alt="OPTIMUS LOGO" height="100px"></a>
              <span class="fs-1"><strong>OPTIMUS</strong> <span class="text-danger">scoreboard</span></span>
           </div>
           <div class="col m-3">
		<a href="about.html" class="btn btn-info pull-right text-nowrap" role="button">About OPTIMUS</a>
           </div>
         </div>
    </header>


<nav id="navigation" class="navbar navbar-dark navbar-expand-lg bg-dark">
  <div class="container-fluid">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse w-100" id="navbarNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a title="сбросить фильтры" class="nav-link link-warning text-truncate" aria-current="page" id="ALL" href="#" onclick="clearCookie();">Выберите сезон и тип соревнований для отображения.</a>
        </li>
        <li class="nav-item m-1">
          <select class="form-select " title="Choose a season" id="Year" onchange="getComboA(this);">
            <option value="">All seasons</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
          </select>
        </li>
        <li class="nav-item m-1">
          <select class="form-select " title="Select a disciplines" id="Type" onchange="getComboA(this);">
            <option value="">All disciplines</option>
            <option value="FS">Formation Skydiving</option>
            <!-- <option value="SF">Speed Formation Skydiving</option> -->
            <option value="AE">Artistic Events</option>
            <option value="CF">Canopy Formation</option>
            <option value="WS" disabled>Wingsuit Flying</option>
<!--
            <option value="SF" disabled>Indoor Solo Freestyle</option>
            <option value="DS" disabled>Indoor Solo Speed</option>
            <option value="DY" disabled>Dynamic Flying</option>
            <option value="SP" disabled>Speed Skydiving</option>
            <option value="CP" disabled>Canopy Piloting</option>
-->
          </select>
        </li>
      </ul>  
      <div role="search" class="d-flex">
          <input class="form-control me-2 d-flex" type="search" placeholder="Search" title="set part of string name or place" id="Name">
          <button class="btn btn-outline-success" type="submit" onclick="getComboA(Name);" id="searchButton">Search</button>
      </div>
    </div>
  </div>
</nav>

<!-- events list -->
<div class="container-fluid">
        <!-- template для построения списка event --> 
        <template  id="event_template">
          <tr class="d-flex flex-row">
            <td class=""><img class="img-fluid mx-2" id="event_logo1" src="" alt="Logo1" onerror="imageError(this)" style="max-height: 80px; max-width: 80px;"></td>
            <td class="d-none d-sm-block"><img class="img-fluid mx-2" id="event_logo2" src="" alt="Logo2" onerror="imageError(this)" style="max-height: 80px; max-width: 80px;"></td>
            <td class="w-100">
              <div class="row">
                <div class="col d-block text-uppercase">
                  <a class="text-decoration-none" id="event_link" href="">
                  <span class="fw-bold" id="event_name"></span>
                  <br>
                  <span class="text-secondary" id="event_date"></span>
                  <br>
                  <span class="text-secondary" id="event_location"></span>
                  </a>
                </div>
                <div class="col d-none d-md-block" id="event_ranks">
                </div>
              </div>
            </td>
          </tr>
        </template>
        <template  id="rank_template">
                  <span class="border-start border-2 px-2" style="display:inline-block;float:right;">
                     <a class="text-decoration-none" id="rank_link" href=""></a> 
                  </span>
        </template>

    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
      <style scoped>
        table td:nth-child(-n+2) {
          width: 100px;
          white-space: nowrap;
          text-align: center;
        }
      </style>
        <tbody id="EventsList">
        </tbody>
      </table>
    </div>
</div>
<!-- events list -->


  <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
    <div class="d-flex p-2 align-items-center flex-fill" style="background-image: radial-gradient(circle at top right,#08088A,#58A2FA 50%);">
      <span class="mb-3 mb-md-0 text-body-secondary"> 
        &copy 2025  <a href="about.html#feedback">Команда Optimus</a><br>
        <a href="about.html#privacy">Privacy Policy</a>
      </span>
    </div>
  </footer>

</div> <!--container-->

  </body>
</html>